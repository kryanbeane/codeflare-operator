// Renovate config for CVE Remediation Controller. Env: RENOVATE_TARGET_REPO, RENOVATE_BASE_BRANCH, RENOVATE_PACKAGE_NAME, RENOVATE_CVE_ID, RENOVATE_MANAGER (gomod | pip_requirements).
// The workflow may call Renovate twice for the same CVE (once for Go, once for Pip); each run uses one manager and one package.
// When RENOVATE_PACKAGE_NAME is "unknown" (scan could not determine module), no package is enabled so Renovate will not open a PR.
const pkg = process.env.RENOVATE_PACKAGE_NAME && process.env.RENOVATE_PACKAGE_NAME !== 'unknown' ? process.env.RENOVATE_PACKAGE_NAME : null;
const manager = process.env.RENOVATE_MANAGER || 'gomod';

const prBody = `## Security Update

This PR fixes **${process.env.RENOVATE_CVE_ID || 'CVE'}** by updating \`${process.env.RENOVATE_PACKAGE_NAME || 'package'}\`.

---
*Created by [CVE Remediation Controller](https://github.com/project-codeflare/codeflare-operator/blob/main/.github/workflows/cve-controller.yml)*
`;

// One manager only: gomod (Go) or pip_requirements (Python).
const enabledManagers = manager === 'pip_requirements' ? ['pip_requirements'] : ['gomod'];
const postUpdateOptions = manager === 'pip_requirements' ? [] : ['gomodTidy'];

module.exports = {
  platform: 'github',
  onboarding: false,
  requireConfig: 'ignored',

  repositories: [process.env.RENOVATE_TARGET_REPO].filter(Boolean),
  baseBranches: [process.env.RENOVATE_BASE_BRANCH].filter(Boolean),
  enabledManagers,

  packageRules: [
    {
      matchPackagePatterns: pkg ? [pkg] : [],
      enabled: true,
      recreateWhen: 'always',
      rebaseWhen: 'behind-base-branch',
      prPriority: 99,
      labels: ['security', 'cve-fix', process.env.RENOVATE_CVE_ID].filter(Boolean),
    },
    {
      matchPackagePatterns: ['*'],
      excludePackagePatterns: pkg ? [pkg] : [],
      enabled: false,
    },
  ],

  prTitle: `fix(security): Update ${process.env.RENOVATE_PACKAGE_NAME || 'package'} [${process.env.RENOVATE_CVE_ID || 'CVE'}]`,
  prBody: prBody,
  branchPrefix: 'cve-fix/',
  branchName: `cve-fix/${process.env.RENOVATE_CVE_ID || 'cve'}-${(process.env.RENOVATE_PACKAGE_NAME || 'pkg').split('/').pop()}`.toLowerCase().replace(/[^a-z0-9-/]/g, '-'),

  dependencyDashboard: false,
  prHourlyLimit: 0,
  prConcurrentLimit: 0,
  branchConcurrentLimit: 0,
  commitMessagePrefix: 'fix(security):',
  postUpdateOptions,
};
